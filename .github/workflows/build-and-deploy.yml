name: Build (backend+frontend) & Deploy to Portainer

on:
  push:
    branches: ["main"]
    paths:
      - "backend/**"
      - "frontend/**"
      - "docker-compose.portainer.tpl.yml"
      - ".github/workflows/build-and-deploy.yml"
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push Backend (multi-arch)
        id: build_backend
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/oc-soccer-backend:latest
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/oc-soccer-backend:main

      - name: Build & Push Frontend (multi-arch)
        id: build_frontend
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/oc-soccer-frontend:latest
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/oc-soccer-frontend:main

      # Resolve digests from outputs of build steps
      - name: Resolve image digests (from build outputs)
        id: digests
        run: |
          set -euo pipefail
          BACKEND_DIGEST="${{ steps.build_backend.outputs.digest }}"
          FRONTEND_DIGEST="${{ steps.build_frontend.outputs.digest }}"
          if [[ -z "$BACKEND_DIGEST" || ! "$BACKEND_DIGEST" =~ ^sha256:[0-9a-f]{64}$ ]]; then
            echo "Invalid backend digest: $BACKEND_DIGEST"
            exit 1
          fi
          if [[ -z "$FRONTEND_DIGEST" || ! "$FRONTEND_DIGEST" =~ ^sha256:[0-9a-f]{64}$ ]]; then
            echo "Invalid frontend digest: $FRONTEND_DIGEST"
            exit 1
          fi
          echo "backend=$BACKEND_DIGEST" >> "$GITHUB_OUTPUT"
          echo "frontend=$FRONTEND_DIGEST" >> "$GITHUB_OUTPUT"
          echo "Backend digest:  $BACKEND_DIGEST"
          echo "Frontend digest: $FRONTEND_DIGEST"

      # Generate Portainer stack file from template
      - name: Generate stack file
        run: |
          set -euo pipefail
          sed "s/__BACKEND_DIGEST__/${{ steps.digests.outputs.backend }}/g; s/__FRONTEND_DIGEST__/${{ steps.digests.outputs.frontend }}/g" \
            docker-compose.portainer.tpl.yml > /tmp/stack.yml
          echo "Generated stack file:" && cat /tmp/stack.yml

      - name: Validate compose (with CI dummy env_file)
        run: |
          set -euo pipefail

          # dummy env file a runneren
          echo "GOOGLE_CLIENT_ID=dummy" > /tmp/backend.env
          echo "GOOGLE_CLIENT_SECRET=dummy" >> /tmp/backend.env
          echo "GOOGLE_REDIRECT_URI=http://localhost/dummy" >> /tmp/backend.env

          # csak validálásra kicseréljük az env_file path-ot
          sed "s|/srv/oc-soccer/env/backend.env|/tmp/backend.env|g" /tmp/stack.yml > /tmp/stack.validate.yml

          docker compose -f /tmp/stack.validate.yml config >/dev/null
          echo "Compose file is valid."

      - name: Debug- show rendered stack header
        run: |
          set -euo pipefail
          echo "=== /tmp/stack.yml (first 120 lines) ==="
          nl -ba /tmp/stack.yml | sed -n '1,120p'
          echo "=== grep sqlite-backup ==="
          grep -n "sqlite-backup" /tmp/stack.yml || true

      - name: Portainer login (JWT)
        id: portainer
        run: |
          set -euo pipefail
          TOKEN="$(curl -ksS -X POST "${{ secrets.PORTAINER_URL }}/api/auth" \
            -H "Content-Type: application/json" \
            -d '{"Username":"'"${{ secrets.PORTAINER_USERNAME }}"'","Password":"'"${{ secrets.PORTAINER_PASSWORD }}"'"}' \
            | python3 -c 'import sys,json; print(json.load(sys.stdin).get("jwt",""))')"
          if [ -z "$TOKEN" ]; then
            echo "Failed to obtain Portainer JWT"
            exit 1
          fi
          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"

      - name: Get stack ID by name
        id: stack
        env:
          PORTAINER_URL: ${{ secrets.PORTAINER_URL }}
          TOKEN: ${{ steps.portainer.outputs.token }}
        run: |
          set -euo pipefail

          HTTP_CODE=$(curl -ksS --fail-with-body -o /tmp/stacks.json -w "%{http_code}" \
            "${PORTAINER_URL}/api/stacks" \
            -H "Authorization: Bearer ${TOKEN}" || true)

          echo "HTTP $HTTP_CODE"
          head -200 /tmp/stacks.json || true

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Failed to list stacks."
            exit 1
          fi

          STACK_ID="$(python3 -c 'import json; d=json.load(open("/tmp/stacks.json","r",encoding="utf-8")); print(next((s["Id"] for s in d if s.get("Name")=="oc-soccer"), ""))')"

          if [ -z "$STACK_ID" ]; then
            echo "Stack 'oc-soccer' not found in /api/stacks list"
            exit 1
          fi

          echo "stack_id=$STACK_ID" >> "$GITHUB_OUTPUT"
          echo "Resolved stack ID: $STACK_ID"

      - name: Read current stack (to preserve env)
        id: stack_details
        env:
          PORTAINER_URL: ${{ secrets.PORTAINER_URL }}
          TOKEN: ${{ steps.portainer.outputs.token }}
          STACK_ID: ${{ steps.stack.outputs.stack_id }}
        run: |
          set -euo pipefail
          curl -ksS \
            "${PORTAINER_URL}/api/stacks/${STACK_ID}?endpointId=2" \
            -H "Authorization: Bearer ${TOKEN}" \
            > /tmp/stack_details.json

          # teljes json (csak debughoz; ne logold ki)
          STACK_DETAILS_JSON="$(python3 -c 'import json; print(json.dumps(json.load(open("/tmp/stack_details.json","r",encoding="utf-8"))))')"
          echo "stack_details_json=$STACK_DETAILS_JSON" >> "$GITHUB_OUTPUT"

          # env tömb
          ENV_JSON="$(python3 -c 'import json; d=json.load(open("/tmp/stack_details.json","r",encoding="utf-8")); print(json.dumps(d.get("Env") or []))')"
          echo "env_json=$ENV_JSON" >> "$GITHUB_OUTPUT"

      - name: Debug - list stacks (name,id,endpoint,projectPath)
        env:
          PORTAINER_URL: ${{ secrets.PORTAINER_URL }}
          TOKEN: ${{ steps.portainer.outputs.token }}
        run: |
          set -euo pipefail
          curl -ksS "${PORTAINER_URL}/api/stacks" \
            -H "Authorization: Bearer ${TOKEN}" \
            | python3 -c 'import sys,json; d=json.load(sys.stdin); 
          print("\n".join([f'{s.get("Id")}  name={s.get("Name")}  endpoint={s.get("EndpointId")}  path={s.get("ProjectPath")}' for s in d]))'

      - name: Debug stack env names (no values)
        env:
          STACK_DETAILS: ${{ steps.stack_details.outputs.stack_details_json }}
        run: |
          set -euo pipefail
          echo "$STACK_DETAILS" > /tmp/stack_details.json
          python3 -c 'import json; d=json.load(open("/tmp/stack_details.json")); env=d.get("Env") or []; print("Env names:", [e.get("name") for e in env])'

      - name: Update Portainer stack content (preserve env)
        env:
          PORTAINER_URL: ${{ secrets.PORTAINER_URL }}
          TOKEN: ${{ steps.portainer.outputs.token }}
          STACK_ID: ${{ steps.stack.outputs.stack_id }}
        run: |
          set -euo pipefail

          STACK_JSON="$(python3 -c 'import json; print(json.dumps(open("/tmp/stack.yml","r",encoding="utf-8").read()))')"
          ENV_JSON='${{ steps.stack_details.outputs.env_json }}'

          HTTP_CODE=$(curl -ksS --fail-with-body -o /tmp/portainer_update_body.txt -w "%{http_code}" \
            -X PUT "${PORTAINER_URL}/api/stacks/${STACK_ID}?endpointId=2" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"StackFileContent\": ${STACK_JSON}, \"Env\": ${ENV_JSON}, \"Prune\": true, \"PullImage\": true}" \
            || true)

          echo "HTTP $HTTP_CODE"
          echo "Body:"
          cat /tmp/portainer_update_body.txt || true

          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "204" ]; then
            echo "Portainer stack update failed."
            exit 1
          fi

          echo "Stack updated."