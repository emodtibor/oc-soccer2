name: Build (backend+frontend) & Deploy to Portainer

on:
  push:
    branches: ["main"]
    paths:
      - "backend/**"
      - "frontend/**"
      - "docker-compose.portainer.tpl.yml"
      - ".github/workflows/build-and-deploy.yml"
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push Backend (multi-arch)
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/oc-soccer-backend:latest
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/oc-soccer-backend:main

      - name: Build & Push Frontend (multi-arch)
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/oc-soccer-frontend:latest
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/oc-soccer-frontend:main

      - name: Resolve image digests (registry manifest, robust)
        id: digests
        run: |
          set -euo pipefail

          BACKEND_IMAGE="docker.io/${{ secrets.DOCKERHUB_USERNAME }}/oc-soccer-backend:main"
          FRONTEND_IMAGE="docker.io/${{ secrets.DOCKERHUB_USERNAME }}/oc-soccer-frontend:main"

          resolve_digest () {
            local ref="$1"
            local d=""

            # 1) buildx template (newer)
            d="$(docker buildx imagetools inspect "$ref" --format '{{.Descriptor.Digest}}' 2>/dev/null || true)"
            if [ -n "$d" ]; then echo "$d"; return 0; fi

            # 2) alternative template (some versions)
            d="$(docker buildx imagetools inspect "$ref" --format '{{.Manifest.Digest}}' 2>/dev/null || true)"
            if [ -n "$d" ]; then echo "$d"; return 0; fi

            # 3) parse plain output
            d="$(docker buildx imagetools inspect "$ref" 2>/dev/null | awk '/^Digest:/ {print $2; exit}')"
            if [ -n "$d" ]; then echo "$d"; return 0; fi

            return 1
          }

          BACKEND_DIGEST="$(resolve_digest "$BACKEND_IMAGE")" || (echo "Cannot resolve digest for $BACKEND_IMAGE" && exit 1)
          FRONTEND_DIGEST="$(resolve_digest "$FRONTEND_IMAGE")" || (echo "Cannot resolve digest for $FRONTEND_IMAGE" && exit 1)

          echo "backend=$BACKEND_DIGEST" >> "$GITHUB_OUTPUT"
          echo "frontend=$FRONTEND_DIGEST" >> "$GITHUB_OUTPUT"

          echo "Backend digest:  $BACKEND_DIGEST"
          echo "Frontend digest: $FRONTEND_DIGEST"
      

      - name: Portainer login (JWT)
        id: portainer
        run: |
          set -euo pipefail
          TOKEN="$(curl -ksS -X POST "${{ secrets.PORTAINER_URL }}/api/auth" \
            -H "Content-Type: application/json" \
            -d '{"Username":"'"${{ secrets.PORTAINER_USERNAME }}"'","Password":"'"${{ secrets.PORTAINER_PASSWORD }}"'"}' \
            | python3 -c 'import sys,json; print(json.load(sys.stdin).get("jwt",""))')"

          if [ -z "$TOKEN" ]; then
            echo "Failed to obtain Portainer JWT"
            exit 1
          fi

          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"

      - name: Update Portainer stack content (stackId=9, endpointId=2)
        env:
          PORTAINER_URL: ${{ secrets.PORTAINER_URL }}
          TOKEN: ${{ steps.portainer.outputs.token }}
        run: |
          set -euo pipefail

          STACK_JSON="$(python3 -c 'import json; print(json.dumps(open("/tmp/stack.yml","r",encoding="utf-8").read()))')"

          curl -ksS -X PUT \
            "${PORTAINER_URL}/api/stacks/9?endpointId=2" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"StackFileContent\": ${STACK_JSON}, \"Prune\": true}" \
            > /tmp/portainer_update.json

          echo "Portainer update response:"
          cat /tmp/portainer_update.json || true

      - name: Deploy stack (stackId=9, endpointId=2)
        env:
          PORTAINER_URL: ${{ secrets.PORTAINER_URL }}
          TOKEN: ${{ steps.portainer.outputs.token }}
        run: |
          set -euo pipefail
          curl -ksS -X POST \
            "${PORTAINER_URL}/api/stacks/9/deploy?endpointId=2" \
            -H "Authorization: Bearer ${TOKEN}"

          echo "Deploy triggered."
